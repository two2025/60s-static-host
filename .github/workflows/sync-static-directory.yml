name: Sync Static Directory

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶ä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-static:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@users.noreply.github.com"
          git config pull.rebase false  # è®¾ç½®åˆå¹¶ç­–ç•¥
          
      - name: Add upstream repository
        run: |
          git remote add upstream https://github.com/vikiboss/60s-static-host.git || true
          git fetch upstream
          
      - name: Create worktree for sync
        run: |
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          git worktree add sync-worktree upstream/main
          
      - name: Copy updated static directory
        run: |
          # æ¸…ç©ºç°æœ‰staticç›®å½•ï¼ˆä¿ç•™.gitignoreç­‰éšè—æ–‡ä»¶ï¼‰
          find static -mindepth 1 -delete
          
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶ï¼ˆåŒ…æ‹¬å­ç›®å½•ï¼‰
          cp -r sync-worktree/static/* static/
          
          # åˆ—å‡ºæ‰€æœ‰æ›´æ–°æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "Updated files:"
          find static -type f | sed 's/^/  /'
          
      - name: Commit and push changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet --exit-code; then
            echo "ğŸŸ¢ No changes detected"
          else
            echo "ğŸŸ  Changes detected - committing updates"
            
            # æ·»åŠ æ‰€æœ‰staticç›®å½•ä¸‹çš„å˜æ›´
            git add static/
            
            # æäº¤å˜æ›´
            git commit -m "Auto-sync static data [$(date +'%Y-%m-%d %H:%M UTC')]"
            
            # æ¨é€å˜æ›´
            git push origin $(git branch --show-current)
          fi
          
      - name: Cleanup worktree
        run: |
          # ç§»é™¤å·¥ä½œæ ‘
          git worktree remove sync-worktree --force
          
          # åˆ é™¤å·¥ä½œæ ‘ç›®å½•
          rm -rf sync-worktree
